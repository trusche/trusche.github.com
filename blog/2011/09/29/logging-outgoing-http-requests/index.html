
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Logging outbound HTTP requests - Thilo Rusche</title>
  <meta name="author" content="Thilo Rusche">

  
  <meta name="description" content="Tweet Logging Outbound HTTP Requests Sep 29th, 2011 Rails logs a ton of details about incoming HTTP requests in debug mode.
But what about outbound &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://trusche.github.com/blog/2011/09/29/logging-outgoing-http-requests/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Thilo Rusche" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body >
  <header role="banner" id="sidebar">
    <!-- Logo -->
<aside id="logo" class="clearfix">
  <div class="clearfix">
    <a href="/">Thilo Rusche</a>
  </div>
</aside>

<ul id="menu">

  <li class="title">
    <h1 id="title"><a href="/">Thilo Rusche</a></h1>
  </li>


  <li class="link">
    <a href="/about/">about</a>
  </li>

  <li class="link">
    <a href="http://twitter.com/trusche/">twitter</a>
  </li>


  <li class="link">
    <a href="http://github.com/trusche/">github</a>
  </li>

  <li class="link rss">
    <a href="/atom.xml">rss feed</a>
  </li>
</ul>



<!-- Octopress Love -->
<aside id="octopress_linkback">
  <a href="http://octopress.org/">
    <span class="unicode_square">
      <span class="unicode_circle">
        &nbsp;
      </span>
    </span>
    <span class="octopress">Powered by Octopress</span>
  </a>
</aside>

  </header>
  <section id="main">
    <article class="post">
  <div class="sharing-box">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://trusche.github.com/blog/2011/09/29/logging-outgoing-http-requests/" data-via="trusche" data-counturl="http://trusche.github.com/blog/2011/09/29/logging-outgoing-http-requests/" data-size="large">Tweet</a>
  
  
  
</div>

  
  <header>
    
      <h2 class="entry-title">Logging Outbound HTTP Requests</h2>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-29T19:13:00+01:00" pubdate data-updated="true">Sep 29<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<p>Rails logs a ton of details about incoming HTTP requests in debug mode.
But what about outbound requests?
Few gems implementing third party APIs bother to log their requests and responses,
and hacking their source code is suboptimal.
Even for outbound HTTP requests made by your own code,
it quickly becomes tedious to sprinkle logging statements
all over the place to get a good look at the data.</p>

<h3>Metaprogramming to the rescue</h3>

<p>Simply override the request method of the
<a href="http://www.ruby-doc.org/stdlib/libdoc/net/http/rdoc/index.html">Net::HTTP module</a> in ruby
to add some logging. Something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Net</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">HTTP</span>
</span><span class='line'>    <span class="n">alias_method</span><span class="p">(</span><span class="ss">:orig_request</span><span class="p">,</span> <span class="ss">:request</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">method_defined?</span><span class="p">(</span><span class="ss">:orig_request</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request: </span><span class="si">#{</span><span class="n">req</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> http://</span><span class="si">#{</span><span class="vi">@address</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@port</span><span class="si">}#{</span><span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span>
</span><span class='line'>          <span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">req</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">body</span> <span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'>          <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;POST Data: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="n">orig_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response: </span><span class="si">#{</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">response</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This inserts the details of any outgoing HTTP request
and it’s response into the standard rails logger.
(Actually, depending on what of the many request methods Net::HTTP
offers is used for the request, it may log some stuff twice.
See my gem below on how to fix that.)</p>

<p>The somewhat whacky looking way of finding the post data
accounts for the different ways in which
<a href="http://www.ruby-doc.org/stdlib/libdoc/net/http/rdoc/classes/Net/HTTP.html#M001363">Net::HTTP::post</a>
and
<a href="http://www.ruby-doc.org/stdlib/libdoc/net/http/rdoc/classes/Net/HTTP.html#M001363">Net::HTTP::post_form</a>
handle that data internally.</p>

<p>You could take this a bit further.
For example, it might be useful to log the TCP connection attempt itself
(since if that fails, the request is never sent, and you’re none the wiser)
by overriding the (private) connect method.</p>

<h3>There&#8217;s a gem for that (now)</h3>

<p>Since I find myself in this situation regularly,
I’ve created a ruby gem, creatively named <a href="http://github.com/trusche/httplog">httplog</a>,
that does just that.
Here’s some (truncated) sample output from a request made by the
<a href="https://github.com/simplegeo/simplegeo-ruby">simplegeo</a> gem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[httplog] Connecting: api.simplegeo.com
</span><span class='line'>[httplog] Sending: GET http://api.simplegeo.com:80/1.0/context/address.json?address=22201&filter=
</span><span class='line'>[httplog] Status: 200
</span><span class='line'>[httplog] Response: {"query":{"latitude":38.885484,"longitude":-77.099113,"address":"22201"...</span></code></pre></td></tr></table></div></figure>


<p>Disclaimer: This is my first published gem, your mileage may vary.
It’s been working fine for me with ruby 1.9.2 and 1.9.3,
but I have not taking extra pains to test it against older versions.
If you run into trouble, feel free to open an issue on <a href="https://github.com/trusche/httplog/issues">github</a>.</p>



</article>


    <nav role="navigation" id="pagination">

</nav>
  </section>
  

  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19547612-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
