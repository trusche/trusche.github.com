<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: logging | Thilo Rusche]]></title>
  <link href="http://trusche.github.com/blog/categories/logging/atom.xml" rel="self"/>
  <link href="http://trusche.github.com/"/>
  <updated>2012-11-27T17:33:40+00:00</updated>
  <id>http://trusche.github.com/</id>
  <author>
    <name><![CDATA[Thilo Rusche]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Logging outbound HTTP requests]]></title>
    <link href="http://trusche.github.com/blog/2011/09/29/logging-outgoing-http-requests/"/>
    <updated>2011-09-29T19:13:00+01:00</updated>
    <id>http://trusche.github.com/blog/2011/09/29/logging-outgoing-http-requests</id>
    <content type="html"><![CDATA[<p>Rails logs a ton of details about incoming HTTP requests in debug mode.
But what about outbound requests?
Few gems implementing third party APIs bother to log their requests and responses,
and hacking their source code is suboptimal.
Even for outbound HTTP requests made by your own code,
it quickly becomes tedious to sprinkle logging statements
all over the place to get a good look at the data.</p>

<h3>Metaprogramming to the rescue</h3>

<p>Simply override the request method of the
<a href="http://www.ruby-doc.org/stdlib/libdoc/net/http/rdoc/index.html">Net::HTTP module</a> in ruby
to add some logging. Something like this:</p>

<p>``` ruby
module Net
  class HTTP</p>

<pre><code>alias_method(:orig_request, :request) unless method_defined?(:orig_request)

def request(req, body = nil, &amp;amp;block)
  Rails.logger.debug("Request: #{req.method} http://#{@address}:#{@port}#{req.path}")

    if req.method == "POST"
      data = req.body.nil? || req.body.size == 0 ? body : req.body
      Rails.logger.debug("POST Data: #{data}")
    end
  end

  response = orig_request(req, body, &amp;amp;block)
  Rails.logger.debug("Response: #{response.body}")

  response
end
</code></pre>

<p>  end
end
```</p>

<p>This inserts the details of any outgoing HTTP request
and it’s response into the standard rails logger.
(Actually, depending on what of the many request methods Net::HTTP
offers is used for the request, it may log some stuff twice.
See my gem below on how to fix that.)</p>

<p>The somewhat whacky looking way of finding the post data
accounts for the different ways in which
<a href="http://www.ruby-doc.org/stdlib/libdoc/net/http/rdoc/classes/Net/HTTP.html#M001363">Net::HTTP::post</a>
and
<a href="http://www.ruby-doc.org/stdlib/libdoc/net/http/rdoc/classes/Net/HTTP.html#M001363">Net::HTTP::post_form</a>
handle that data internally.</p>

<p>You could take this a bit further.
For example, it might be useful to log the TCP connection attempt itself
(since if that fails, the request is never sent, and you’re none the wiser)
by overriding the (private) connect method.</p>

<h3>There's a gem for that (now)</h3>

<p>Since I find myself in this situation regularly,
I’ve created a ruby gem, creatively named <a href="http://github.com/trusche/httplog">httplog</a>,
that does just that.
Here’s some (truncated) sample output from a request made by the
<a href="https://github.com/simplegeo/simplegeo-ruby">simplegeo</a> gem:</p>

<p><code>plain
[httplog] Connecting: api.simplegeo.com
[httplog] Sending: GET http://api.simplegeo.com:80/1.0/context/address.json?address=22201&amp;filter=
[httplog] Status: 200
[httplog] Response: {"query":{"latitude":38.885484,"longitude":-77.099113,"address":"22201"...
</code></p>

<p>Disclaimer: This is my first published gem, your mileage may vary.
It’s been working fine for me with ruby 1.9.2 and 1.9.3,
but I have not taking extra pains to test it against older versions.
If you run into trouble, feel free to open an issue on <a href="https://github.com/trusche/httplog/issues">github</a>.</p>
]]></content>
  </entry>
  
</feed>
